<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mobile FPS - Muzzle Flash</title>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; touch-action: none; }
    
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
    #hud { 
        position: absolute; top: 20px; left: 20px; color: #00ffcc; 
        background: rgba(0, 0, 0, 0.4); padding: 10px; border-left: 3px solid #00ffcc; 
    }
    #crosshair { 
        position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; 
        border: 2px solid #00ffcc; border-radius: 50%; transform: translate(-50%, -50%); 
    }
    #loading { 
        position: absolute; top: 50%; width: 100%; text-align: center; 
        color: yellow; transform: translateY(-50%); z-index: 20; 
    }

    /* CONTROLS */
    #joystick-zone {
        position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px;
        background: rgba(255, 255, 255, 0.1); border-radius: 50%; pointer-events: auto; z-index: 10;
    }
    #joystick-knob {
        position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
        background: #00ffcc; border-radius: 50%; transform: translate(-50%, -50%);
    }
    #shoot-btn {
        position: absolute; bottom: 50px; right: 40px; width: 90px; height: 90px;
        background: rgba(255, 0, 0, 0.2); border: 4px solid #ff0000; border-radius: 50%;
        pointer-events: auto; z-index: 100; /* Ensure this is on top of everything */
        box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    }
    #touch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
</style>
</head>
<body>

<div id="loading">CHECKING ASSETS...</div>
<div id="touch-layer"></div>
<div id="joystick-zone"><div id="joystick-knob"></div></div>
<div id="shoot-btn"></div> 

<div id="ui-layer">
    <div id="crosshair"></div>
    <div id="hud">
        HP: <span id="hp">100</span> | WAVE: <span id="wave">1</span>
    </div>
</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

let camera, scene, renderer, gunModel, zombieModel, muzzleFlash;
const enemies = [];
const input = { moveX: 0, moveY: 0 };
const loader = new GLTFLoader();

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    scene.fog = new THREE.Fog(0x050505, 1, 40);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.rotation.order = 'YXZ';
    camera.position.set(0, 1.6, 0);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    
    // Muzzle Flash Light
    muzzleFlash = new THREE.PointLight(0xffaa00, 0, 5);
    camera.add(muzzleFlash);
    scene.add(camera);

    // Floor
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(100, 100),
        new THREE.MeshStandardMaterial({ color: 0x111111 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.05;
    scene.add(floor);

    setupControls();
    spawnWave();
    
    setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 4000);

    // Try to load models from assets/models/
    loader.load('assets/models/gun.glb', (gltf) => {
        gunModel = gltf.scene;
        updateGun(gunModel);
        document.getElementById('loading').style.display = 'none';
    }, undefined, () => updateGun(null));

    loader.load('assets/models/zombie.glb', (gltf) => {
        zombieModel = gltf.scene;
    });
}

function updateGun(model) {
    if(camera.getObjectByName("gun")) camera.remove(camera.getObjectByName("gun"));
    let gun = model || new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.5), new THREE.MeshStandardMaterial({color: 0x00ffcc}));
    gun.name = "gun";
    gun.position.set(0.3, -0.3, -0.6);
    camera.add(gun);
}

function setupControls() {
    const knob = document.getElementById('joystick-knob');
    const zone = document.getElementById('joystick-zone');
    
    // Movement
    const handleJoy = (t) => {
        const rect = zone.getBoundingClientRect();
        const dx = t.clientX - (rect.left + rect.width/2);
        const dy = t.clientY - (rect.top + rect.height/2);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        const angle = Math.atan2(dy, dx);
        input.moveX = (Math.cos(angle) * dist) / 40;
        input.moveY = (Math.sin(angle) * dist) / 40;
        knob.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
    };

    zone.addEventListener('touchstart', (e) => handleJoy(e.touches[0]));
    zone.addEventListener('touchmove', (e) => handleJoy(e.touches[0]));
    zone.addEventListener('touchend', () => {
        input.moveX = 0; input.moveY = 0;
        knob.style.transform = `translate(-50%, -50%)`;
    });

    // Look
    let px, py;
    document.getElementById('touch-layer').addEventListener('touchstart', (e) => {
        px = e.touches[0].clientX; py = e.touches[0].clientY;
    });
    document.getElementById('touch-layer').addEventListener('touchmove', (e) => {
        camera.rotation.y -= (e.touches[0].clientX - px) * 0.005;
        camera.rotation.x -= (e.touches[0].clientY - py) * 0.005;
        camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
        px = e.touches[0].clientX; py = e.touches[0].clientY;
    });

    // Fire
    document.getElementById('shoot-btn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        shoot();
    });
}

function spawnWave() {
    for(let i=0; i<6; i++) {
        const enemy = zombieModel ? zombieModel.clone() : new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0xff0000}));
        const a = Math.random() * Math.PI * 2;
        enemy.position.set(Math.cos(a)*20, 1, Math.sin(a)*20);
        enemy.userData = { hp: 30 };
        scene.add(enemy);
        enemies.push(enemy);
    }
}

function shoot() {
    // 1. Muzzle Flash Effect
    muzzleFlash.intensity = 15;
    setTimeout(() => { muzzleFlash.intensity = 0; }, 50);

    // 2. Gun Recoil
    const gun = camera.getObjectByName("gun");
    if(gun) {
        gun.position.z += 0.1;
        setTimeout(() => gun.position.z -= 0.1, 50);
    }

    // 3. Hit Detection
    const ray = new THREE.Raycaster();
    ray.setFromCamera(new THREE.Vector2(0,0), camera);
    const hits = ray.intersectObjects(enemies, true);
    if(hits.length > 0) {
        let obj = hits[0].object;
        while(obj.parent && !enemies.includes(obj)) obj = obj.parent;
        if(enemies.includes(obj)) {
            obj.userData.hp -= 10;
            if(obj.userData.hp <= 0) {
                scene.remove(obj);
                enemies.splice(enemies.indexOf(obj), 1);
                if(enemies.length === 0) spawnWave();
            }
        }
    }
}

function animate() {
    requestAnimationFrame(animate);
    const forward = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
    const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
    forward.y = 0; right.y = 0;
    camera.position.addScaledVector(forward, -input.moveY * 0.12);
    camera.position.addScaledVector(right, input.moveX * 0.12);

    enemies.forEach(en => {
        const dir = new THREE.Vector3().subVectors(camera.position, en.position).normalize();
        en.position.x += dir.x * 0.04;
        en.position.z += dir.z * 0.04;
        en.lookAt(camera.position.x, en.position.y, camera.position.z);
    });
    renderer.render(scene, camera);
}
</script>
</body>
</html>
