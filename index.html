<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Abandoned Orbitron</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="https://fonts.googleapis.com" rel="stylesheet" />
<style>
    html, body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; touch-action: none; user-select: none; height: 100%; }
    canvas { display: block; position: fixed; inset: 0; z-index: 1; }
    #hud { position: fixed; top: 20px; left: 20px; color: #00ffcc; z-index: 100; font-size: 18px; pointer-events: none; text-shadow: 0 0 10px #00ffcc; }
    #crosshair { position: fixed; top: 50%; left: 50%; width: 18px; height: 18px; border: 2px solid #00ffcc; border-radius: 50%; transform: translate(-50%, -50%); z-index: 90; pointer-events: none; }
    #look-layer { position: fixed; inset: 0; z-index: 5; }
    #joystick-zone { position: fixed; bottom: 40px; left: 40px; width: 110px; height: 110px; border-radius: 50%; border: 2px solid rgba(0,255,204,0.3); background: rgba(255,255,255,0.05); z-index: 110; backdrop-filter: blur(5px); }
    #knob { position: absolute; top: 35px; left: 35px; width: 40px; height: 40px; background: #00ffcc; border-radius: 50%; box-shadow: 0 0 15px #00ffcc; }
    #shoot-btn { position: fixed; bottom: 50px; right: 50px; width: 90px; height: 90px; border-radius: 50%; border: 4px solid #ff0000; background: rgba(255,0,0,0.2); z-index: 110; touch-action: none; }
    #loading { position: fixed; inset: 0; background: #000; color: #00ffcc; display: flex; align-items: center; justify-content: center; z-index: 1000; }
</style>
</head>
<body>

<div id="loading">INITIALIZING NEURAL LINK...</div>
<div id="hud">HP: 100 | KILLS: <span id="kills">0</span></div>
<div id="crosshair"></div>
<div id="look-layer"></div>
<div id="joystick-zone"><div id="knob"></div></div>
<div id="shoot-btn"></div>

<script type="importmap">
{ "imports": { "three": "https://unpkg.com", "three/addons/": "https://unpkg.com" } }
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

const CONFIG = { moveSpeed: 7.0, lookSensitivity: 0.003, enemyCount: 6 };
const clock = new THREE.Clock();
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020205);
scene.fog = new THREE.Fog(0x020205, 1, 20);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 5);
camera.rotation.order = 'YXZ';
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Environment setup (same as previous)
const wallMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.9 });
const floorMat = new THREE.MeshStandardMaterial({ color: 0x080808 });
const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), floorMat);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);
// ... ceiling and pillars code ...

const light = new THREE.PointLight(0xffffff, 15, 12);
camera.add(light);
scene.add(camera);

// Weapon loading (same as previous, assuming assets/models/gun.glb)
const loader = new GLTFLoader();
loader.load('assets/models/gun.glb', gltf => {
    const gun = gltf.scene;
    gun.position.set(0.35, -0.35, -0.5);
    gun.scale.setScalar(0.5);
    camera.add(gun);
}, undefined, err => console.warn('Gun model failed to load', err));

/* =====================
   ENEMIES (ZOMBIES with Animations)
===================== */
const enemies = [];
const mixers = []; // Store all animation mixers here

function spawnEnemy() {
    loader.load('assets/models/zombie.glb', gltf => {
        const enemy = gltf.scene;
        enemy.position.set((Math.random() - 0.5) * 30, 0, (Math.random() - 0.5) * 30);
        enemy.scale.setScalar(0.8);
        enemy.userData = { hp: 50, speed: 1.0 + Math.random() * 0.5 };
        scene.add(enemy);
        enemies.push(enemy);

        // Setup animation mixer
        const mixer = new THREE.AnimationMixer(enemy);
        // Assuming your GLB file has an animation named 'walk' or similar
        const clip = gltf.animations.find(anim => anim.name === 'walk' || anim.duration > 0); 
        if (clip) {
            mixer.clipAction(clip).play();
        } else {
            console.warn("No suitable animation found in zombie model.");
        }
        mixers.push(mixer);

    }, undefined, err => {
        console.warn('Zombie model failed to load', err);
        // Fallback to placeholder cube if model fails
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0x8b0000}));
        mesh.position.set((Math.random() - 0.5) * 30, 1, (Math.random() - 0.5) * 30);
        mesh.userData = { hp: 50, speed: 1.0 + Math.random() * 0.5 };
        scene.add(mesh);
        enemies.push(mesh);
    });
}
for (let i = 0; i < CONFIG.enemyCount; i++) spawnEnemy();


/* =====================
   INPUT HANDLING (Same as previous)
===================== */
const input = { move: { x: 0, y: 0 }, lastLook: null };
// ... joystick and touch logic here ...

// Shooting Logic (Updated to manage mixers if enemy is killed)
const raycaster = new THREE.Raycaster();
let recoilAnim = 0;
shootBtn.addEventListener('touchstart', e => {
    e.preventDefault();
    recoilAnim = 0.15;
    raycaster.setFromCamera({ x: 0, y: 0 }, camera);
    const hits = raycaster.intersectObjects(enemies);
    
    if (hits.length > 0) {
        const target = hits[0].object;
        // Find the top-level enemy object (since the hit might be on a child mesh)
        const enemyParent = target.isMesh ? target.parent : target;

        enemyParent.userData.hp -= 10;
        if (enemyParent.userData.hp <= 0) {
            scene.remove(enemyParent);
            const index = enemies.indexOf(enemyParent);
            if (index > -1) {
                enemies.splice(index, 1);
                // Remove associated mixer as well
                mixers.splice(index, 1); 
            }
            spawnEnemy();
            document.getElementById('kills').innerText = parseInt(document.getElementById('kills').innerText) + 1;
        }
    }
});

/* =====================
   GAME LOOP (Updated to run mixers)
===================== */
function animate() {
  const delta = clock.getDelta();
  requestAnimationFrame(animate);

  // Update all animation mixers using delta time
  mixers.forEach(mixer => mixer.update(delta));

  // Movement (same as previous)
  const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
  const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
  forward.y = 0; right.y = 0; 
  camera.position.addScaledVector(forward.normalize(), -input.move.y * CONFIG.moveSpeed * delta);
  camera.position.addScaledVector(right.normalize(), input.move.x * CONFIG.moveSpeed * delta);

  // Gun Animation (same as previous)
  gunGroup.position.z = THREE.MathUtils.lerp(gunGroup.position.z, -0.5 + recoilAnim, 0.2);
  recoilAnim = THREE.MathUtils.lerp(recoilAnim, 0, 0.1);

  // Enemy AI: Enemies must look at the camera when walking
  enemies.forEach(enemy => {
    // enemy.position.lerp(camera.position, 0.005); // Use this for smooth approach
    // Calculate direction and make the model look at player while keeping feet on the ground
    const targetPos = new THREE.Vector3(camera.position.x, enemy.position.y, camera.position.z);
    enemy.lookAt(targetPos);
  });

  renderer.render(scene, camera);
}

animate();
document.getElementById('loading').style.display = 'none';

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
